<script>
 window.UsersTable = {
  template: '#users-table',
  setup() {
    const utilityStore = useUtilityStore();
    const customerStore = useCustomerStore();
    const userStore = useUserStore();
    const snackbarStore = useSnackbarStore();
    return {userStore, utilityStore, customerStore, snackbarStore};
  },
  data() {
    return {
      formTitle: 'Edit Customer Request',
      appIsLoading: false,
      showNewItemBtn: false,
      prefs : {
        Locale: "en-US",
        Currency: "USD"
      },
      dialog: false,
      viewDialog: false,
      editedIndex: -1,
      editedItem: {},
      indexedDD : {
        Roles: {
          Admin: { description: "System administrator with full access" },
          Manager: { description: "Manages teams and projects" },
          User: { description: "Regular user with limited permissions" }
        },
        Statuses: {
          Active: { description: "Account is active" },
          Inactive: { description: "Account is inactive" },
          Suspended: { description: "Account has been suspended" }
        },
        Tags: {
          New: { description: "Recently joined" },
          VIP: { description: "High-value customer" },
          Support: { description: "Needs dedicated support" },
          Onboarding: { description: "Currently onboarding" }
        }
      },
      schema: [
        {
          key: 'id',
          label: 'Request Id',
          type: 'text',
          rules: [(v) => !!v || "This is required!"],
          disabled: true,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 4,
            sm: 6
          }
        },
        {
          key: 'customerName',
          label: 'Customer Name',
          type: 'text',
          rules: [(v) => !!v || "This is required!"],
          disabled: false,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 4,
            sm: 6
          }
        },
        {
          key: 'customerEmail',
          label: 'Customer Email',
          type: 'email',
          rules: [(v) => !!v || "This is required!"],
          disabled: false,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 4,
            sm: 6
          }
        },
        {
          key: 'customerContact',
          label: 'Contact',
          type: 'text',
          rules: [],
          disabled: false,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 4,
            sm: 6
          }
        },
        {
          key: 'requestType',
          label: 'Request Type',
          type: 'select',
          options: this.utilityStore.getCustomerRequestsDropdownOptions?.requestType,
          rules: [(v) => !!v || "This is required!"],
          disabled: false,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 4,
            sm: 6
          }
        },
        {
          key: 'stage',
          label: 'Stage',
          type: 'select',
          options: this.utilityStore.getCustomerRequestsDropdownOptions?.stage,
          rules: [(v) => !!v || "This is required!"],
          disabled: false,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 4,
            sm: 6
          }
        },
        {
          key: 'cost',
          label: 'Cost',
          type: 'number',
          rules: [(v) => !!v || "This is required!"],
          disabled: false,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 4,
            sm: 6
          }
        },
        {
          key: 'priority',
          label: 'Priority',
          type: 'select',
          options: this.utilityStore.getCustomerRequestsDropdownOptions?.priority,
          rules: [(v) => !!v || "This is required!"],
          disabled: false,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 4,
            sm: 6
          }
        },
        {
          key: 'assignedTo',
          label: 'Assigned To',
          type: 'text',
          rules: [],
          disabled: false,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 4,
            sm: 6
          }
        },
        {
          key: 'deliveryDate',
          label: 'Delivery Date',
          type: 'date',
          rules: [],
          disabled: false,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 4,
            sm: 6
          }
        },
        {
          key: 'createdDate',
          label: 'Created Date',
          type: 'text',
          rules: [(v) => !!v || "This is required!"],
          disabled: true,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 4,
            sm: 6
          }
        },
        {
          key: 'updatedDate',
          label: 'Updated Date',
          type: 'text',
          rules: [(v) => !!v || "This is required!"],
          disabled: true,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 4,
            sm: 6
          }
        },
          {
          key: 'description',
          label: 'Description',
          type: 'textarea',
          rules: [],
          disabled: false,
          formHidden: false,
          col_size:{
            cols: 12,
            md: 12,
            sm: 12
          }
        }
      ],
      search: "",
    }
  },
  beforeMount() {
    this.customerStore.fetchCustomerRequestsIfEmpty()
    this.userStore.fetchUsersIfEmpty()
  },
  computed: {   
    tableData() {
      return this.customerStore.getCustomerRequests.map(custR => ({
        id: custR.id,
        customerName: custR.customerName,
        customerContact: custR.customerContact,
        customerEmail: custR.customerEmail,
        assignedTo: custR.assignedTo,
        cost: custR.cost,
        stage: custR.stage,
        deliveryDate: custR.deliveryDate,
        priority: custR.priority,
      }));
    },
    headers() {
      const includedHeaders = [
      'id',
      'customerName',
      'customerContact',
      'customerEmail',
      'assignedTo',
      'cost',
      'stage',
      'deliveryDate',
      'priority',
      'actions'
      ]
      return this.customerStore.getCustomerRequestHeaders.filter(custRH => includedHeaders.includes(custRH.key));
    }
  },
  methods: {

    searchRequestById(id) {
      return this.customerStore.getCustomerRequests.find(req => req.id === id) || null
    },

    editItem(item) {
      logger.log('Table Request selected', item)
    
      this.editedItem = this.searchRequestById(item.id)
      console.log('Full Request details: ', this.editedItem)

      this.dialog = true;
    },

    handleAddNewBtn() {
    
    },

    viewItem(item){
   
      logger.log('Table Request selected', item)

      this.editedItem = this.searchRequestById(item.id) 
      logger.log(' Full Request details: ', this.editedItem)

      this.viewDialog = true;
    },

    close() {
      this.dialog = false;
      this.$nextTick(() => {
        this.editedItem = {};
      });
    },

    async save() {

      // Get the form instance
      const form = this.$refs.form

      if (form) {
        const { valid } = await form.validate()

        if (!valid) {
          logger.log("Form validation failed")
          return
        }

        // proceed with saving since validation passed
        logger.log("Form is valid:", this.editedItem)

        const body = {
          customerRequestId: this.editedItem.id,
          customerRequestData: this.editedItem
        }

        const request = {body}

        logger.log('Update Customer Request Body: ', body)

        apiCall('CONTROLLER_UPDATE_CUSTOMER_REQUESTS', request)
          .then(async response=>{

            logger.log('Response from customer request update ', response)

            logger.log('refreshing customer requests..... ')
            
            this.close()

            await this.customerStore.fetchFreshCustomerRequests()

            //show welcome popup
            this.snackbarStore.showSnackbar(`Record Updated successfully.`, "teal");

          })
          .catch(error=>{

            this.snackbarStore.showSnackbar(error?.message, "red");
            logger.error('Error Response from customer request update ', error)

          })

        
      }


      // logger.log("Preparing to update customer request: ", this.editedItem)
      // //await response = await apiCall('CONTROLLER_UPDATE_CUSTOMER_REQUESTS', {})
      // if (!this.$refs.form.validate()) {
      //   logger.log("Form is invalid")
      //   logger.log(this.$refs.form.items)
      //   //return this.showSnackbar({message: "Form is invalid", color: "warning"})
      // } else{
      //   logger.log("Form is valid")
      //   logger.log(this.$refs.form.items)
      // }

      //this.showSnackbar("Saving item...", "info");
      //this.runBeforeSaving();
      // if (!this.validate()) {
      //   return;
      // }
      //if (this.editedIndex > -1) {
        // console.log("Edited Item", this.editedItem);
        // if (
        //   this.appName === "Design And Printing" ||
        //   this.appName === "Design"
        // ) {
        //   this.constructEditHistory(this.editedItem);
        // }


        // google.script.run
        //   .withSuccessHandler((res) => {
        //     this.showSnackbar(`Record saved successfully!`, "success");
        //     this.loadDataTable(res);
        //     this.resetForm();
        //   })
        //   .withFailureHandler((error) => {
        //     console.log(error);
        //   })
        //   .updateRecordById(this.editedItem, this.appSchema);


      //} else {
        // google.script.run
        //   .withSuccessHandler((res) => {
        //     this.showSnackbar(`Record saved successfully!`, "success");
        //     this.loadDataTable(res);
        //     this.resetForm();
        //   })
        //   .withFailureHandler((error) => {
        //     console.log(error);
        //   })
        //   .createRecord(this.editedItem, this.appSchema);
      //}
      //this.close();
    },

  }
};
</script>