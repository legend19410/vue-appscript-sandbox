<script>
 window.CustomerRequestsTable = {
  template: '#customer-requests-table',
  setup() {
    const utilityStore = useUtilityStore();
    return { utilityStore};
  },
  data() {
    return {
      formTitle: 'Edit Customer Request',
      headers : [],
      dataTable: [],
      appIsLoading: false,
      showNewItemBtn: false,
      prefs : {
        Locale: "en-US",
        Currency: "USD"
      },
      dialog: false,
      viewDialog: false,
      editedIndex: -1,
      editedItem : {
          customerName: "Alice Johnson",
          customerEmail: "alice.johnson@example.com",
          customerContact: '11879938377',
          requestType: "Rental",
          stage: "Delivered",             
          cost: "1000000",          
          assignedTo: "francis@milton.com",    
          deliveryDate: "1988-03-14T00:00:00Z",  // ISO date
          createdDate: "1988-03-14T00:00:00Z",     
          updatedDate: "1988-03-14T00:00:00Z",    // link
          description: "A sleek oak writing desk with smooth tapered legs, a matte finish, and two concealed drawers, blending modern minimalism with timeless craftsmanship, perfect for home offices or quiet reading corners.",                
          history: JSON.stringify([
            "Created on 2023-01-05",
            "Promoted to Manager on 2023-06-20",
            "Salary updated on 2024-01-15"
          ])
      },
      indexedDD : {
        Roles: {
          Admin: { description: "System administrator with full access" },
          Manager: { description: "Manages teams and projects" },
          User: { description: "Regular user with limited permissions" }
        },
        Statuses: {
          Active: { description: "Account is active" },
          Inactive: { description: "Account is inactive" },
          Suspended: { description: "Account has been suspended" }
        },
        Tags: {
          New: { description: "Recently joined" },
          VIP: { description: "High-value customer" },
          Support: { description: "Needs dedicated support" },
          Onboarding: { description: "Currently onboarding" }
        }
      },
      rules: {
        required: (value) => !!value || "Required.",
      },
      schema: [
            {
              key: 'customerName',
              label: 'Customer Name',
              type: 'text',
              required: true,
              disabled: false,
              formHidden: false,
              col_size:{
                cols: 12,
                md: 4,
                sm: 6
              }
            },
            {
              key: 'customerEmail',
              label: 'Customer Email',
              type: 'email',
              required: true,
              disabled: false,
              formHidden: false,
              col_size:{
                cols: 12,
                md: 4,
                sm: 6
              }
            },
            {
              key: 'customerContact',
              label: 'Contact',
              type: 'text',
              required: false,
              disabled: false,
              formHidden: false,
              col_size:{
                cols: 12,
                md: 4,
                sm: 6
              }
            },
            {
              key: 'requestType',
              label: 'Request Type',
              type: 'select',
              options: ['Admin','Manager','User'],
              required: true,
              disabled: false,
              formHidden: false,
              col_size:{
                cols: 12,
                md: 4,
                sm: 6
              }
            },
            {
              key: 'stage',
              label: 'Stage',
              type: 'select',
              options: ['Admin','Manager','User'],
              required: true,
              disabled: false,
              formHidden: false,
              col_size:{
                cols: 12,
                md: 4,
                sm: 6
              }
            },
            {
              key: 'cost',
              label: 'Cost',
              type: 'text',
              required: false,
              disabled: false,
              formHidden: false,
              col_size:{
                cols: 12,
                md: 4,
                sm: 6
              }
            },
            {
              key: 'assignedTo',
              label: 'Assigned To',
              type: 'text',
              required: false,
              disabled: false,
              formHidden: false,
              col_size:{
                cols: 12,
                md: 4,
                sm: 6
              }
            },
            {
              key: 'deliveryDate',
              label: 'Delivery Date',
              type: 'date',
              required: false,
              disabled: false,
              formHidden: false,
              col_size:{
                cols: 12,
                md: 4,
                sm: 6
              }
            },
            {
              key: 'createdDate',
              label: 'Created Date',
              type: 'date',
              required: true,
              disabled: false,
              formHidden: false,
              col_size:{
                cols: 12,
                md: 4,
                sm: 6
              }
            },
            {
              key: 'updateDate',
              label: 'Updated Date',
              type: 'date',
              required: true,
              disabled: false,
              formHidden: false,
              col_size:{
                cols: 12,
                md: 4,
                sm: 6
              }
            },
              {
              key: 'description',
              label: 'Description',
              type: 'textarea',
              required: false,
              disabled: false,
              formHidden: false,
              col_size:{
                cols: 12,
                md: 6,
                sm: 6
              }
            }
      ],
      search: "",
    }
  },
  beforeMount() {
    this.getCustomers()
  },
  mounted() {
   // this.getAllData()
  },
  methods: {
    async getCustomers(){
      this.utilityStore.showLoadingSpinner()
      const response = await apiCall('CONTROLLER_GET_ALL_CUSTOMER_REQUESTS', {})
      this.dataTable = response.data.data
      this.headers = response.data.headers
      this.utilityStore.hideLoadingSpinner()


      console.log('customer requests response: ',response)
    },
    async getCustomerRequestById(id){
      const body = {
        customerRequestId: id
      }
      this.utilityStore.showLoadingSpinner()

      const response = await apiCall('CONTROLLER_GET_CUSTOMER_REQUESTS_BY_ID', {body})
      console.log('customer request response: ',response)
      this.utilityStore.hideLoadingSpinner()

      return response.data

    },
    async getAllData(){
      //const response = await apiCall('getData', {})
     // console.log('data response: ',response)

      google.script.run
          .withSuccessHandler((res) => {
              console.log('data response: ',res)
              console.log('header keys: ',this.headers)

              this.dataTable = res
          })
          .withFailureHandler((error) => {
            console.log(error);
          })
          .getData();
    },
   async editItem(item) {
    const customerRequest = await this.getCustomerRequestById(item.id)
    console.log('ITEM TO BEEEE EDITED', item)
      //this.editedIndex = this.dataTable.indexOf(item);
      this.editedItem = customerRequest//Object.assign({}, item);
    console.log(' EDITED item', this.editedItem)

      this.dialog = true;
    },
    handleAddNewBtn() {
    
    },
    async viewItem(item){
      const customerRequest = await this.getCustomerRequestById(item.id)
      console.log('ITEM TO BEEEE EDITED', item)
        //this.editedIndex = this.dataTable.indexOf(item);
        this.editedItem = customerRequest//Object.assign({}, item);
      console.log(' EDITED item', this.editedItem)

      this.viewDialog = true;
    }
  }
};
</script>